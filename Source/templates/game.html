<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Battleship Board</title>
  <style>
    :root{
      --bg:#111213; --panel:#1e1e1f; --panel-border:#2b2b2c; --board-bg:#151516;
      --cell-border:#2b2b2c; --unguessed:#3d3d3f; --miss:#333335; --miss-dot:#232324;
      --hit:#d71919; --hit-border:#7a0c0c; --sunk:#5a0a0a; --text:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;padding:20px}
    
    .header{text-align:center;margin-bottom:20px}
    .header h1{font-size:2.5em;margin:0 0 10px 0;color:#fff;text-shadow:0 0 10px rgba(255,255,255,.3)}
    
    .info-panel{display:flex;justify-content:space-around;gap:30px;margin-bottom:20px;background:var(--panel);border:1px solid var(--panel-border);border-radius:10px;padding:15px 30px;box-shadow:0 4px 12px rgba(0,0,0,.5)}
    .info-item{text-align:center}
    .info-label{font-size:0.85em;color:#888;margin-bottom:5px}
    .info-value{font-size:1.6em;font-weight:bold;color:#fff}
    
    .board-wrap{background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;padding:12px;box-shadow:0 8px 32px rgba(0,0,0,.6)}
    .board{display:grid;grid-template-columns:repeat(10,60px);grid-template-rows:repeat(10,60px);gap:6px;background:var(--board-bg);padding:6px;border-radius:10px}
    .cell{position:relative;border:1px solid var(--cell-border);border-radius:6px;background:var(--unguessed);transition:all 0.3s ease}

    /* 0 unguessed with probability heatmap */
    .unguessed{background:var(--unguessed)}

    /* 1 miss */
    .miss{background:var(--miss)}
    .miss::after{content:"";position:absolute;inset:0;margin:auto;width:20px;height:20px;border-radius:50%;background:var(--miss-dot);box-shadow:inset 0 2px 4px rgba(0,0,0,.35)}

    /* 2 hit (bright red circle + glow) */
    .hit{background:var(--hit);border-color:var(--hit-border);box-shadow:0 0 22px rgba(215,25,25,.6), inset 0 -6px 10px rgba(0,0,0,.35);animation:glow 1.4s ease-in-out infinite}
    .hit::after{content:"";position:absolute;inset:0;margin:auto;width:28px;height:28px;border-radius:50%;background:#fff;box-shadow:0 0 14px rgba(255,255,255,.9)}
    @keyframes glow{0%,100%{box-shadow:0 0 22px rgba(215,25,25,.6), inset 0 -6px 10px rgba(0,0,0,.35)}50%{box-shadow:0 0 36px rgba(215,25,25,.85), inset 0 -6px 10px rgba(0,0,0,.35)}}

    /* 3 sunk (dark red with X) */
    .sunk{background:var(--sunk);border-color:var(--hit-border);box-shadow:inset 0 -6px 14px rgba(0,0,0,.6)}
    .sunk::before,.sunk::after{content:"";position:absolute;inset:0;margin:auto;width:55%;height:3px;background:#fff;border-radius:2px;opacity:.9}
    .sunk::before{transform:rotate(45deg)}
    .sunk::after{transform:rotate(-45deg)}
    
    .last-move-indicator{margin-top:20px;text-align:center;padding:15px;background:var(--panel);border:1px solid var(--panel-border);border-radius:8px;font-size:1.1em;box-shadow:0 4px 12px rgba(0,0,0,.5)}
    
    /* Responsive design */
    @media (max-width: 768px) {
      .header h1{font-size:1.8em}
      .info-panel{flex-direction:column;gap:10px;padding:10px 20px}
      .board{grid-template-columns:repeat(10,40px);grid-template-rows:repeat(10,40px);gap:4px}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸŽ¯ Battleship Automation</h1>
  </div>
  
  <div class="info-panel">
    <div class="info-item">
      <div class="info-label">Game</div>
      <div class="info-value" id="game-number">-</div>
    </div>
    <div class="info-item">
      <div class="info-label">Total Games</div>
      <div class="info-value" id="total-games">-</div>
    </div>
    <div class="info-item">
      <div class="info-label">Moves</div>
      <div class="info-value" id="move-count">0</div>
    </div>
  </div>

  <div class="board-wrap"><div id="board" class="board"></div></div>
  
  <div class="last-move-indicator" id="last-move">
    Waiting for game to start...
  </div>

  <script>
    const board = document.getElementById('board');
    const gameNumberEl = document.getElementById('game-number');
    const totalGamesEl = document.getElementById('total-games');
    const moveCountEl = document.getElementById('move-count');
    const lastMoveEl = document.getElementById('last-move');

    // Create the 10x10 grid
    for(let i=0;i<100;i++){
      const cell = document.createElement('div');
      cell.className = 'cell unguessed';
      cell.dataset.row = Math.floor(i / 10);
      cell.dataset.col = i % 10;
      board.appendChild(cell);
    }

    const cells = board.children;

    // Map backend state names to numeric codes
    function stateToCode(stateName) {
      const stateMap = {
        'unknown': 0,
        'miss': 1,
        'hit': 2,
        'sunk': 3
      };
      return stateMap[stateName] !== undefined ? stateMap[stateName] : 0;
    }

    // Update a single cell
    function updateCell(row, col, state, probability) {
      const i = row * 10 + col;
      const cell = cells[i];
      if (!cell) return;
      
      const stateCode = (typeof state === 'number') ? state : stateToCode(state);
      const className = ['unguessed', 'miss', 'hit', 'sunk'][stateCode];
      cell.className = 'cell ' + className;
      
      // Only show probability heatmap on unguessed cells
      if (stateCode === 0 && probability !== undefined && probability > 0) {
        // Enhanced visibility: square root scaling to make low values more visible
        // This ensures even probability values as low as 0.01 are still visible
        const enhancedProb = Math.sqrt(probability);
        
        // Interpolate from dark brown (low prob) to bright yellow/orange (high prob)
        const intensity = Math.floor(enhancedProb * 255);
        const r = Math.min(255, 80 + intensity);       // 80-255 range
        const g = Math.min(200, 40 + intensity * 0.8);  // 40-200 range
        const b = 20;                                   // Constant low blue
        cell.style.background = `rgb(${r}, ${g}, ${b})`;
      } else {
        cell.style.background = '';
      }
    }

    // Update entire board from 2D state array
    function updateBoard(boardData) {
      for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
          const cellData = boardData[r][c];
          const state = (typeof cellData === 'object') ? cellData.state : cellData;
          const probability = (typeof cellData === 'object') ? cellData.probability : 0;
          updateCell(r, c, state, probability);
        }
      }
    }

    // Fetch and update game state from backend
    async function updateGameState() {
      try {
        const response = await fetch('/api/state');
        const data = await response.json();

        // Update info panel
        gameNumberEl.textContent = data.game_number;
        totalGamesEl.textContent = data.total_games;
        moveCountEl.textContent = data.move_count;

        // Update last move indicator
        if (data.last_move) {
          const [row, col] = data.last_move.position;
          const result = data.last_move.result;
          lastMoveEl.innerHTML = `Last Move: <strong>(${row}, ${col})</strong> - ${result.toUpperCase()}`;
        } else if (data.is_running) {
          lastMoveEl.textContent = 'Game in progress...';
        } else {
          lastMoveEl.textContent = 'Waiting for game to start...';
        }

        // Update board cells
        data.board.forEach((row, rowIndex) => {
          row.forEach((cellData, colIndex) => {
            updateCell(rowIndex, colIndex, cellData.state, cellData.probability || 0);
          });
        });

      } catch (error) {
        console.error('Error fetching game state:', error);
        lastMoveEl.textContent = 'Error connecting to server...';
      }
    }

    // Make functions available globally for debugging
    window.updateCell = updateCell;
    window.updateBoard = updateBoard;

    // Update every 50ms for smooth animation
    setInterval(updateGameState, 50);
    
    // Initial update
    updateGameState();
  </script>
</body>
</html>
